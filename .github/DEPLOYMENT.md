# Deployment Setup Guide

This guide explains how to set up CI/CD for the Celebrum AI Go project using GitHub Actions.

## Required GitHub Secrets

To enable automatic deployment, you need to configure the following secrets in your GitHub repository:

### Repository Secrets

Go to your GitHub repository → Settings → Secrets and variables → Actions → New repository secret

#### Required Secrets:

1. **`DIGITALOCEAN_ACCESS_TOKEN`**
   - Your DigitalOcean API token
   - Used for deployment operations
   - Get from: DigitalOcean Control Panel → API → Tokens/Keys

2. **`DEPLOY_SSH_KEY`**
   - Private SSH key for accessing your deployment server
   - Should be the private key corresponding to the public key added to your server
   - Generate with: `ssh-keygen -t ed25519 -C "github-actions@celebrum-ai"

3. **`DEPLOY_USER`**
   - Username for SSH access to your deployment server
   - Example: `root` or `deploy`

4. **`DEPLOY_HOST`**
   - IP address or hostname of your deployment server
   - Example: `your-server-ip` or `celebrum-ai.com`

#### Application Secrets (Required):

5. **`JWT_SECRET`**
   - Secret key for JWT token signing
   - Auto-generated by setup script or create with: `openssl rand -base64 64`

6. **`TELEGRAM_BOT_TOKEN`**
   - Telegram bot token from @BotFather
   - Required for Telegram bot functionality

7. **`TELEGRAM_WEBHOOK_URL`**
   - HTTPS URL for Telegram webhook
   - Format: `https://yourdomain.com/webhook`

8. **`TELEGRAM_WEBHOOK_SECRET`**
   - Secret for webhook verification
   - Auto-generated by setup script or create with: `openssl rand -hex 32`

9. **`FEATURE_TELEGRAM_BOT`**
   - Enable/disable Telegram bot feature
   - Set to `true` for production

#### Optional Secrets:

10. **`SLACK_WEBHOOK_URL`** (Optional)
    - Slack webhook URL for deployment notifications
    - Get from: Slack → Apps → Incoming Webhooks

11. **`DISCORD_WEBHOOK_URL`** (Optional)
    - Discord webhook URL for deployment notifications

### Repository Variables

Go to your GitHub repository → Settings → Secrets and variables → Actions → Variables tab

1. **`PRODUCTION_URL`**
   - Your production application URL
   - Example: `https://celebrum-ai.com`

## Automated Secrets Setup

We provide an automated setup script to configure all required GitHub secrets:

```bash
# Run the setup script
./scripts/setup-github-secrets.sh
```

This script will:
- Generate secure random secrets for JWT and webhook verification
- Prompt you for required tokens and credentials
- Set all secrets in your GitHub repository
- Provide instructions for SSH key setup

## Manual Secrets Setup

If you prefer to set up secrets manually, follow the steps below.

## Server Setup

### 1. Prepare Your Server

Ensure your deployment server has:

```bash
# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Create deployment directory
sudo mkdir -p /opt/celebrum-ai-go
sudo chown $USER:$USER /opt/celebrum-ai-go
```

### 2. Add SSH Key

Add the public key to your server:

```bash
# On your server
mkdir -p ~/.ssh
echo "your-public-key-here" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

### 3. Clone Repository

```bash
cd /opt/celebrum-ai-go
git clone https://github.com/your-username/celebrum-ai-go.git .
```

### 4. Setup Environment

The CI/CD pipeline will automatically create the `.env` file on your server using GitHub Secrets. You don't need to manually create or manage `.env` files on the server.

For local development, create your local environment file:

```bash
cp .env.example .env.local
# Edit .env.local with your local values
nano .env.local
```

**Important**: Never commit `.env` files to git. They are already excluded in `.gitignore`.

## CI/CD Pipeline Overview

The GitHub Actions workflow (`.github/workflows/ci-cd.yml`) includes:

### 1. Test Job
- Runs on every push and pull request
- Sets up Go environment
- Runs linting with golangci-lint
- Executes tests with coverage
- Builds the application
- Uses PostgreSQL and Redis services for integration tests

### 2. Build and Push Job
- Runs only on pushes to main branch
- Builds Docker image
- Pushes to GitHub Container Registry (ghcr.io)
- Tags with branch name and latest

### 3. Deploy Job
- Runs only on pushes to main branch after successful build
- Connects to your server via SSH
- Pulls latest Docker images
- Updates the deployment using docker-compose
- Performs health checks

### 4. Notify Job
- Sends deployment status notifications
- Runs regardless of success/failure

## Manual Deployment

You can also deploy manually using the Makefile:

```bash
# Deploy to production
make deploy

# Deploy to staging
make deploy-staging

# Run CI checks locally
make ci-check
```

## Monitoring and Logs

### View Deployment Logs
```bash
# On your server
tail -f /var/log/celebrum-ai-deploy.log
```

### View Application Logs
```bash
# On your server
cd /opt/celebrum-ai-go
docker-compose logs -f
```

### Health Check
```bash
# Check if application is running
curl -f http://your-server/health
```

## Rollback Procedure

If deployment fails, the system automatically attempts rollback. For manual rollback:

```bash
# On your server
cd /opt/celebrum-ai-go

# Stop current deployment
docker-compose down

# Restore from backup
sudo cp -r /var/backups/celebrum-ai/backup-YYYYMMDD-HHMMSS/* .

# Start services
docker-compose up -d
```

## Environment Variables & Secrets Management

### How It Works

The CI/CD pipeline handles environment variables automatically:

1. **GitHub Secrets** → **Server .env file** during deployment
2. **No manual .env file management** on the server required
3. **Secure secret storage** using GitHub's encrypted secrets
4. **Automatic environment creation** for each deployment

### Environment Variable Reference

| Variable | Source | Required | Description |
|----------|--------|----------|-------------|
| `JWT_SECRET` | GitHub Secret | Yes | JWT signing key |
| `TELEGRAM_BOT_TOKEN` | GitHub Secret | Yes | Telegram bot token |
| `TELEGRAM_WEBHOOK_URL` | GitHub Secret | Yes | HTTPS webhook URL |
| `TELEGRAM_WEBHOOK_SECRET` | GitHub Secret | Yes | Webhook verification |
| `FEATURE_TELEGRAM_BOT` | GitHub Secret | Yes | Enable Telegram bot |
| `ENVIRONMENT` | CI/CD | Auto-set | Set to `production` |

### Local Development Setup

For local development, use `.env.local` instead of `.env`:

```bash
# Copy example file
cp .env.example .env.local

# Edit with your local values
nano .env.local

# Run locally
make docker-run
```

### Secrets Validation

Before deployment, validate your secrets:

```bash
# Check all required secrets are set
gh secret list | grep -E "(JWT_SECRET|TELEGRAM_BOT_TOKEN|TELEGRAM_WEBHOOK_URL|TELEGRAM_WEBHOOK_SECRET|FEATURE_TELEGRAM_BOT)"

# Verify deployment secrets
gh secret list | grep -E "(DEPLOY_HOST|DEPLOY_USER|DEPLOY_SSH_KEY|DIGITALOCEAN_ACCESS_TOKEN)"
```

## Troubleshooting

### Environment Variables & Secrets Issues

1. **CI Failed: Missing Environment Variables**
   - **Symptoms**: Build succeeds but deployment fails with "environment variable not found"
   - **Solution**: Run `./scripts/setup-github-secrets.sh` to configure missing secrets
   - **Check**: `gh secret list` to verify all required secrets are set

2. **CI Failed: Invalid Telegram Bot Token**
   - **Symptoms**: Application fails to start with Telegram-related errors
   - **Solution**: Verify `TELEGRAM_BOT_TOKEN` in GitHub Secrets matches your bot token
   - **Check**: Test token with `curl -X GET https://api.telegram.org/bot<token>/getMe`

3. **CI Failed: Webhook URL Issues**
   - **Symptoms**: Telegram webhook setup fails
   - **Solution**: Ensure `TELEGRAM_WEBHOOK_URL` uses HTTPS and matches your domain
   - **Check**: Verify webhook URL is accessible via HTTPS

4. **Local Development: Missing Environment Variables**
   - **Symptoms**: Application fails to start locally
   - **Solution**: Create `.env.local` file from `.env.example`
   - **Check**: Ensure `.env.local` is not committed to git

### Common Issues

1. **SSH Connection Failed**
   - Verify SSH key is correctly added to server
   - Check DEPLOY_USER and DEPLOY_HOST secrets
   - Ensure server allows SSH connections

2. **Docker Build Failed**
   - Check Dockerfile syntax
   - Verify all dependencies are available
   - Check GitHub Container Registry permissions

3. **Health Check Failed**
   - Verify application starts correctly
   - Check database connectivity
   - Review application logs

4. **Environment Variable Not Found**
   - Check GitHub Secrets are properly configured
   - Verify secret names match expected format
   - Review deployment logs for specific missing variables

4. **Permission Denied**
   - Ensure deploy user has Docker permissions
   - Add user to docker group: `sudo usermod -aG docker $USER`

### Debug Commands

```bash
# Check GitHub Actions logs
# Go to: GitHub Repository → Actions → Select workflow run

# Check server status
ssh user@server 'docker ps'
ssh user@server 'docker-compose ps'

# Check application logs
ssh user@server 'cd /opt/celebrum-ai-go && docker-compose logs app'
```

## Security Considerations

1. **SSH Keys**: Use dedicated SSH keys for deployment, not your personal keys
2. **Secrets**: Never commit secrets to the repository
3. **Server Access**: Limit SSH access to deployment user only
4. **Firewall**: Configure firewall to allow only necessary ports
5. **Updates**: Keep server and Docker updated regularly

## Environment-Specific Configuration

### Staging Environment
- Uses `docker-compose.yml`
- Deploys on pushes to `development` branch
- Uses staging database and services

### Production Environment
- Uses `docker-compose.single-droplet.yml`
- Deploys on pushes to `main` branch
- Uses production database and services
- Includes additional monitoring and backup

## Support

For deployment issues:
1. Check GitHub Actions logs
2. Review server logs
3. Verify all secrets are correctly configured
4. Ensure server meets requirements